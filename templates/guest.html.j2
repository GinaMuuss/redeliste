{% extends "layout.html.j2" %}
{% block head %}
    <script type="text/javascript" charset="utf-8">
        document.addEventListener("DOMContentLoaded", function(){

            // Connect to the Socket.IO server.
            namespace = '/{{ room.guest_key }}';
            var socket = io(namespace);

            // Handlers for the different types of hands.
            var is_channel_hand_up = {};

            socket.on('data_update', function(data, cb) {
                console.log(data);
                for(var x in data){
                   var channel = data[x];
                   var found = false;
                   for(var y in data[x]["current_list"]){
                       var user = data[x]["current_list"][y];
                       console.log(user)
                       console.log("{{session['user'].name}}")
                       console.log(channel)
                       if (user == "{{session['user'].name}}" ) {
                          found = true;
                       }
                    }
                    if (found) {
                       document.getElementById(channel.channel_id).innerText = "Lower "+ channel.name;
                       is_channel_hand_up[channel.channel_id] = true;
                       found = false;
                    } else {
                        document.getElementById(channel.channel_id).innerText = "Raise "+ channel.name;
                        is_channel_hand_up[channel.channel_id] = false;
                    }
                }
            });

            {% for channel in room.get_channels() %}
                document.getElementById('{{channel.id}}').addEventListener("click", function(){
                    if(is_channel_hand_up["{{channel.id}}"]){
                        // The hand is up  -> we should lower it 
                        socket.emit('lower_hand_event', {channel_id: '{{channel.id}}', });
                        is_channel_hand_up["{{channel.id}}"] = false;
                        document.getElementById("{{channel.id}}").innerText = "Raise {{channel.name}}";
                        // TODO: maybe wait for confirmation
                    }
                    else{
                        // The hand is down -> we should raise it
                        socket.emit('raise_hand_event', {channel_id: '{{channel.id}}'});
                        is_channel_hand_up["{{channel.id}}"] = true;
                        document.getElementById("{{channel.id}}").innerText = "Lower {{channel.name}}";
                        // TODO: maybe wait for confirmation
                    }
                    return false;
                });
            {%- endfor %}
        });
    </script>
{% endblock %}
{% block body %}
    <h1>Hi {{ session["user"].name }}</h1>
    <h2>Send:</h2>
    {% for channel in room.get_channels() %}
        <button id="{{channel.id}}">Raise {{channel.name}}</button>
    {%- endfor %}
{% endblock %}
